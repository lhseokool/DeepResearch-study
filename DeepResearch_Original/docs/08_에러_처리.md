# 에러 처리 및 견고성

## 1. 토큰 제한 초과 처리

### 토큰 제한 감지

```python
def is_token_limit_exceeded(exception: Exception, model_name: str = None) -> bool:
    """예외가 토큰/컨텍스트 제한 초과를 나타내는지 판단"""
    error_str = str(exception).lower()
    
    # 제공자별 확인
    if provider == "openai":
        return _check_openai_token_limit(exception, error_str)
    elif provider == "anthropic":
        return _check_anthropic_token_limit(exception, error_str)
    elif provider == "gemini":
        return _check_gemini_token_limit(exception, error_str)
```

### 재시도 전략

**1. 메시지 절단**
```python
if is_token_limit_exceeded(e, configurable.research_model):
    researcher_messages = remove_up_to_last_ai_message(researcher_messages)
    continue
```

**2. 점진적 절단**
```python
# 첫 번째 재시도: 초기 제한 설정
findings_token_limit = model_token_limit * 4

# 후속 재시도: 10%씩 감소
findings_token_limit = int(findings_token_limit * 0.9)
findings = findings[:findings_token_limit]
```

## 2. 구조화된 출력 재시도

```python
clarification_model = (
    llm_model
    .with_structured_output(ClarifyWithUser)
    .with_retry(stop_after_attempt=configurable.max_structured_output_retries)
    .with_config(model_config)
)
```

## 3. 도구 실행 에러

```python
async def execute_tool_safely(tool, args, config):
    try:
        return await tool.ainvoke(args, config)
    except Exception as e:
        return f"Error executing tool: {str(e)}"
```

## 4. MCP 인증 에러

```python
if error_code == -32003:  # Interaction required
    error_message = message_payload.get("text")
    if url := error_data.get("url"):
        error_message = f"{error_message} {url}"
    raise ToolException(error_message) from original_error
```

## 5. 타임아웃 처리

```python
summary = await asyncio.wait_for(
    model.ainvoke([HumanMessage(content=prompt_content)]),
    timeout=60.0,
)
```

## 6. 동시성 제한

```python
allowed_calls = conduct_research_calls[:configurable.max_concurrent_research_units]
overflow_calls = conduct_research_calls[configurable.max_concurrent_research_units:]

for overflow_call in overflow_calls:
    all_tool_messages.append(
        ToolMessage(content=f"Error: Exceeded maximum concurrent units...")
    )
```
