# DeepResearch 아키텍처 개요

## 시스템 소개

DeepResearch는 **LangChain과 LangGraph를 활용한 계층적 멀티 에이전트 연구 시스템**입니다. 복잡한 연구 작업을 자동으로 분해하고 병렬 처리하여 효율적으로 수행합니다.

## 전체 아키텍처

### 3계층 구조

```
┌─────────────────────────────────────────────────────────┐
│           Main Graph (deep_researcher)                  │
├─────────────────────────────────────────────────────────┤
│  1. clarify_with_user                                   │
│     └─ 사용자 요청 명확화                                    │
│                                                         │
│  2. write_research_brief                                │
│     └─ 연구 계획서 작성                                     │
│                                                         │
│  3. research_supervisor (Supervisor Subgraph)           │
│     ├─ supervisor (연구 전략 수립)                          │
│     └─ supervisor_tools (연구 위임 및 조정)                 │
│         └─ Researcher Subgraph × N (병렬 실행)             │
│                                                         │
│  4. final_report_generation                             │
│     └─ 최종 보고서 작성                                     │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│         Supervisor Subgraph (연구 조정자)                │
├─────────────────────────────────────────────────────────┤
│  - 연구 작업을 여러 Researcher에게 위임                  │
│  - 병렬 처리 및 결과 조정                                │
│  - 도구: ConductResearch, ResearchComplete, think_tool  │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│      Researcher Subgraph (개별 연구자)                   │
├─────────────────────────────────────────────────────────┤
│  1. researcher (연구 수행)                               │
│     └─ 검색 도구 호출                                    │
│                                                          │
│  2. researcher_tools (도구 실행)                         │
│     └─ tavily_search, think_tool, MCP 도구              │
│                                                          │
│  3. compress_research (결과 압축)                        │
│     └─ 연구 결과 요약 및 정리                            │
└─────────────────────────────────────────────────────────┘
```

## 핵심 설계 원칙

### 1. 계층적 분리 (Hierarchical Separation)
- **Main Graph**: 전체 워크플로우 조정
- **Supervisor**: 연구 전략 수립 및 작업 위임
- **Researcher**: 실제 연구 수행

### 2. 병렬 처리 (Parallel Execution)
- 여러 Researcher가 동시에 독립적인 연구 수행
- `asyncio.gather()`를 통한 비동기 병렬 실행
- 최대 동시 실행 수 제어 (`max_concurrent_research_units`)

### 3. 상태 격리 (State Isolation)
- 각 계층은 독립적인 State 관리
- Subgraph 간 데이터 전달은 명시적으로 정의
- `override_reducer`를 통한 유연한 상태 업데이트

### 4. 동적 라우팅 (Dynamic Routing)
- `Command(goto=...)` 패턴으로 조건부 흐름 제어
- 런타임에 다음 노드 결정
- 종료 조건에 따른 조기 종료

## 실행 흐름 예시

```
사용자 입력: "OpenAI와 Anthropic의 AI 안전성 접근법 비교"

1. clarify_with_user
   └─ 명확화 불필요 판단 → write_research_brief로 이동

2. write_research_brief
   └─ 연구 계획서 생성: "OpenAI와 Anthropic의 AI 안전성 접근법 비교 연구"

3. research_supervisor
   ├─ supervisor: 2개의 연구 작업 계획
   │   ├─ ConductResearch("OpenAI의 AI 안전성 접근법")
   │   └─ ConductResearch("Anthropic의 AI 안전성 접근법")
   │
   └─ supervisor_tools: 2개 Researcher 병렬 실행
       ├─ Researcher 1 (OpenAI)
       │   ├─ tavily_search("OpenAI AI safety")
       │   ├─ think_tool("결과 분석")
       │   ├─ tavily_search("OpenAI alignment research")
       │   └─ compress_research
       │
       └─ Researcher 2 (Anthropic)
           ├─ tavily_search("Anthropic AI safety")
           ├─ think_tool("결과 분석")
           ├─ tavily_search("Anthropic constitutional AI")
           └─ compress_research

4. final_report_generation
   └─ 모든 연구 결과 종합 → 비교 분석 보고서 작성
```

## 주요 특징

### 1. 확장성 (Scalability)
- 연구 주제 수에 따라 자동으로 Researcher 수 조정
- 병렬 처리로 시간 효율성 극대화

### 2. 견고성 (Robustness)
- 토큰 제한 초과 시 자동 재시도 및 메시지 절단
- 도구 실행 오류 처리
- 구조화된 출력 재시도 로직

### 3. 유연성 (Flexibility)
- 다양한 검색 API 지원 (Tavily, OpenAI, Anthropic)
- MCP 도구 통합 가능
- 모델별 설정 커스터마이징

### 4. 투명성 (Transparency)
- think_tool을 통한 추론 과정 가시화
- 원본 데이터(raw_notes)와 압축 데이터 모두 보존
- 소스 인용 추적

## 기술 스택

- **LangChain**: LLM 통합, 도구 바인딩, 구조화된 출력
- **LangGraph**: 상태 기반 워크플로우, Subgraph, 동적 라우팅
- **Pydantic**: 타입 안전성, 데이터 검증
- **asyncio**: 비동기 병렬 처리
- **Tavily**: 웹 검색 API
- **MCP**: 외부 도구 통합 프로토콜
